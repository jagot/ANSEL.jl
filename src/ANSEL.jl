module ANSEL

using Unicode

# For reference, see https://en.wikipedia.org/wiki/ANSEL

ansel_map = [0x0000 0x0001 0x0002 0x0003 0x0004 0x0005 0x0006 0x0007 0x0008 0x0009 0x000A 0x000B 0x000C 0x000D 0x000E 0x000F
             0x0010 0x0011 0x0012 0x0013 0x0014 0x0015 0x0016 0x0017 0x0018 0x0019 0x001A 0x001B 0x001C 0x001D 0x001E 0x001F
             0x0020 0x0021 0x0022 0x0023 0x0024 0x0025 0x0026 0x0027 0x0028 0x0029 0x002A 0x002B 0x002C 0x002D 0x002E 0x002F
             0x0030 0x0031 0x0032 0x0033 0x0034 0x0035 0x0036 0x0037 0x0038 0x0039 0x003A 0x003B 0x003C 0x003D 0x003E 0x003F
             0x0040 0x0041 0x0042 0x0043 0x0044 0x0045 0x0046 0x0047 0x0048 0x0049 0x004A 0x004B 0x004C 0x004D 0x004E 0x004F
             0x0050 0x0051 0x0052 0x0053 0x0054 0x0055 0x0056 0x0057 0x0058 0x0059 0x005A 0x005B 0x005C 0x005D 0x005E 0x005F
             0x0060 0x0061 0x0062 0x0063 0x0064 0x0065 0x0066 0x0067 0x0068 0x0069 0x006A 0x006B 0x006C 0x006D 0x006E 0x006F
             0x0070 0x0071 0x0072 0x0073 0x0074 0x0075 0x0076 0x0077 0x0078 0x0079 0x007A 0x007B 0x007C 0x007D 0x007E 0x007F
             0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000
             0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000
             0x0000 0x0141 0x00D8 0x0110 0x00DE 0x00C6 0x0152 0x02B9 0x00B7 0x266D 0x00AE 0x00B1 0x01A0 0x01AF 0x02BC 0x0000
             0x02BB 0x0142 0x00F8 0x0111 0x00FE 0x00E6 0x0153 0x02BA 0x0131 0x00A3 0x00F0 0x0000 0x01A1 0x01B0 0x0000 0x0000
             0x00B0 0x2113 0x2117 0x00A9 0x266F 0x00BF 0x00A1 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000
             0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000
             0x0309 0x0300 0x0301 0x0302 0x0303 0x0304 0x0306 0x0307 0x0308 0x030C 0x030A 0xFE20 0xFE21 0x0315 0x030B 0x0310
             0x0327 0x0328 0x0323 0x0324 0x0325 0x0333 0x0332 0x0326 0x031C 0x032E 0xFE22 0xFE23 0x0000 0x0000 0x0313 0x0000]

gedcom_map = Dict(0xbe => 0x25a1,
                  0xbf => 0x25a0,
                  0xcd => 0x0065,
                  0xce => 0x006f,
                  0xcf => 0x00df,
                  0xfc => 0x0338)

function ansel2unicode(b::UInt8)
    i = Integer(b >> 4) + 1
    j = Integer(b & 0xf) + 1
    ansel_map[i,j]
end

gedcom2unicode(b::UInt8) = get(gedcom_map, b, ansel2unicode(b))

function anselgedcom2unicode(data::Vector{UInt8}, t::Function)
    utf8data = t.(data)
    # In the ANSEL specification, diacritic marks precede the
    # decorated letters, whereas in Unicode they follow the decorated
    # letters instead.
    for i ∈ findall(b -> b & 0xf0 ≥ 0xe0 , data)
        utf8data[[i,i+1]] = utf8data[[i+1,i]]
    end
    Unicode.normalize(transcode(String, utf8data), :NFC)
end

ansel2unicode(data) = anselgedcom2unicode(data, ansel2unicode)
gedcom2unicode(data) = anselgedcom2unicode(data, gedcom2unicode)

export ansel2unicode, gedcom2unicode

end # module
